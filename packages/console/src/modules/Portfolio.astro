---
import buyerPortfolio from '../../resources/api/portfolio/buyer_id/USR-100001.json';
import performanceData from '../../resources/api/portfolio/buyer_id/performance.json';

const portfolioSummary = buyerPortfolio.summary;
const activeInvestments = buyerPortfolio.data.filter(item => item.status.code === 'SOLD_AND_OUTSTANDING');
const completedInvestments = buyerPortfolio.data.filter(item => item.status.code === 'SOLD_MATURED');

const formatCurrency = (amount: number | null) => {
	if (amount === null) return '-';
	return `RM ${amount.toLocaleString('en-MY', {
		minimumFractionDigits: 2,
		maximumFractionDigits: 2
	})}`;
};

const formatDate = (dateStr: string) => {
	return new Date(dateStr).toLocaleDateString('en-GB', {
		day: '2-digit',
		month: 'short',
		year: 'numeric'
	});
};
---

<div class="px-4 pt-6">
	<!-- Performance Chart and Summary Statistics - Side by Side -->
	<div class="grid gap-4 xl:grid-cols-3">
		<!-- Performance Chart with Tabs (2/3 width) -->
		<div
			class="xl:col-span-2 p-4 bg-white border border-gray-200 rounded-lg shadow-sm sm:p-6 dark:border-gray-700 dark:bg-gray-800"
		>
			<div class="mb-4">
				<h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
					{performanceData.graph_title}
				</h3>
				<p class="text-sm text-gray-500 dark:text-gray-400">
					{performanceData.summary.performance_period}
				</p>
			</div>

			<!-- Tabs -->
			<div class="mb-4 border-b border-gray-200 dark:border-gray-700">
				<ul class="flex flex-wrap -mb-px text-sm font-medium text-center" role="tablist">
					<li class="mr-2" role="presentation">
						<button
							class="inline-block p-4 border-b-2 rounded-t-lg tab-button active"
							id="capital-tab"
							data-tabs-target="#capital-chart-content"
							type="button"
							role="tab"
							aria-controls="capital-chart-content"
							aria-selected="true"
						>
							Capital Growth
						</button>
					</li>
					<li class="mr-2" role="presentation">
						<button
							class="inline-block p-4 border-b-2 rounded-t-lg tab-button"
							id="profit-tab"
							data-tabs-target="#profit-chart-content"
							type="button"
							role="tab"
							aria-controls="profit-chart-content"
							aria-selected="false"
						>
							Profit & ROI
						</button>
					</li>
				</ul>
			</div>

			<!-- Tab Contents -->
			<div id="tab-contents">
				<div class="tab-content active" id="capital-chart-content" role="tabpanel" aria-labelledby="capital-tab">
					<div id="capital-growth-chart"></div>
				</div>
				<div class="tab-content hidden" id="profit-chart-content" role="tabpanel" aria-labelledby="profit-tab">
					<div id="profit-trend-chart"></div>
				</div>
			</div>
		</div>

		<!-- Summary Statistics Table (1/3 width) -->
		<div
			class="xl:col-span-1 p-4 bg-white border border-gray-200 rounded-lg shadow-sm sm:p-6 dark:border-gray-700 dark:bg-gray-800"
		>
			<div class="mb-4">
				<h3 class="text-lg font-semibold text-gray-900 dark:text-white">
					Portfolio Summary
				</h3>
				<p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
					Key metrics and statistics
				</p>
			</div>

			<div class="overflow-x-auto">
				<table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
					<thead
						class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400"
					>
						<tr>
							<th scope="col" class="p-4">Metric</th>
							<th scope="col" class="p-4">Value</th>
						</tr>
					</thead>
					<tbody>
						<tr class="border-b dark:border-gray-700">
							<td class="p-4 font-medium text-gray-900 dark:text-white">
								Total Invested
							</td>
							<td class="p-4 font-semibold text-gray-900 dark:text-white font-mono">
								{formatCurrency(portfolioSummary.total_invested_rm)}
							</td>
						</tr>
						<tr class="border-b dark:border-gray-700">
							<td class="p-4 font-medium text-gray-900 dark:text-white">
								Total Expected Return
							</td>
							<td class="p-4 font-semibold text-gray-900 dark:text-white font-mono">
								{formatCurrency(portfolioSummary.total_expected_return_rm)}
							</td>
						</tr>
						<tr class="border-b dark:border-gray-700">
							<td class="p-4 font-medium text-gray-900 dark:text-white">
								Total Profit Earned
							</td>
							<td class="p-4 font-semibold text-green-600 dark:text-green-400 font-mono">
								{formatCurrency(portfolioSummary.total_profit_earned_rm)}
							</td>
						</tr>
						<tr class="border-b dark:border-gray-700">
							<td class="p-4 font-medium text-gray-900 dark:text-white">
								Active Receivables
							</td>
							<td class="p-4 font-semibold text-gray-900 dark:text-white">
								{portfolioSummary.active_count}
							</td>
						</tr>
						<tr>
							<td class="p-4 font-medium text-gray-900 dark:text-white">
								Completed Receivables
							</td>
							<td class="p-4 font-semibold text-gray-900 dark:text-white">
								{portfolioSummary.completed_count}
							</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
	</div>

	<!-- Active Investments Table -->
	<div class="mt-4 mb-4">
		<div
			class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm sm:p-6 dark:border-gray-700 dark:bg-gray-800"
		>
			<div class="flex items-center justify-between mb-4">
				<h3 class="text-lg font-semibold text-gray-900 dark:text-white">
					Active Investments
					<span
						class="ml-2 text-sm font-normal text-gray-500 dark:text-gray-400"
					>
						({activeInvestments.length} items)
					</span>
				</h3>
			</div>

			<div class="overflow-x-auto">
				<table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
					<thead
						class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400"
					>
						<tr>
							<th scope="col" class="p-4">ID</th>
							<th scope="col" class="p-4">Branch</th>
							<th scope="col" class="p-4">Asset</th>
							<th scope="col" class="p-4">Purchase Price</th>
							<th scope="col" class="p-4">Expected Return</th>
							<th scope="col" class="p-4">Profit Rate (PA)</th>
							<th scope="col" class="p-4">Start Date</th>
							<th scope="col" class="p-4">Maturity Date</th>
							<th scope="col" class="p-4">Status</th>
						</tr>
					</thead>
					<tbody>
						{activeInvestments.map((item) => (
							<tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
								<td class="p-4 font-medium text-gray-900 dark:text-white">
									{item.id}
								</td>
								<td class="p-4 text-gray-900 dark:text-white">
									{item.branch}
								</td>
								<td class="p-4">
									<div class="text-gray-900 dark:text-white">{item.asset.type}</div>
									<div class="text-xs text-gray-500 dark:text-gray-400">
										{item.asset.weight_gram}g
									</div>
								</td>
								<td class="p-4 font-mono text-gray-900 dark:text-white">
									{formatCurrency(item.purchase_price_rm)}
								</td>
								<td class="p-4 font-mono text-gray-900 dark:text-white">
									{formatCurrency(item.expected_return_rm)}
								</td>
								<td class="p-4 text-gray-900 dark:text-white">
									{item.profit_rate_pa}%
								</td>
								<td class="p-4 text-gray-900 dark:text-white">
									{formatDate(item.start_date)}
								</td>
								<td class="p-4 text-gray-900 dark:text-white">
									{formatDate(item.maturity_date)}
								</td>
								<td class="p-4">
									<span
										class="px-2.5 py-0.5 rounded-md text-xs font-medium border"
										style={`background-color: ${item.status.color}20; color: ${item.status.color}; border-color: ${item.status.color}40;`}
									>
										{item.status.label}
									</span>
								</td>
							</tr>
						))}
					</tbody>
				</table>
			</div>
		</div>
	</div>

	<!-- Completed Investments Table -->
	<div class="mb-4">
		<div
			class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm sm:p-6 dark:border-gray-700 dark:bg-gray-800"
		>
			<div class="flex items-center justify-between mb-4">
				<h3 class="text-lg font-semibold text-gray-900 dark:text-white">
					Completed Investments
					<span
						class="ml-2 text-sm font-normal text-gray-500 dark:text-gray-400"
					>
						({completedInvestments.length} items)
					</span>
				</h3>
			</div>

			<div class="overflow-x-auto">
				<table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
					<thead
						class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400"
					>
						<tr>
							<th scope="col" class="p-4">ID</th>
							<th scope="col" class="p-4">Branch</th>
							<th scope="col" class="p-4">Asset</th>
							<th scope="col" class="p-4">Purchase Price</th>
							<th scope="col" class="p-4">Expected Return</th>
							<th scope="col" class="p-4">Profit Earned</th>
							<th scope="col" class="p-4">Profit Rate (PA)</th>
							<th scope="col" class="p-4">Start Date</th>
							<th scope="col" class="p-4">Maturity Date</th>
							<th scope="col" class="p-4">Status</th>
						</tr>
					</thead>
					<tbody>
						{completedInvestments.map((item) => (
							<tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
								<td class="p-4 font-medium text-gray-900 dark:text-white">
									{item.id}
								</td>
								<td class="p-4 text-gray-900 dark:text-white">
									{item.branch}
								</td>
								<td class="p-4">
									<div class="text-gray-900 dark:text-white">{item.asset.type}</div>
									<div class="text-xs text-gray-500 dark:text-gray-400">
										{item.asset.weight_gram}g
									</div>
								</td>
								<td class="p-4 font-mono text-gray-900 dark:text-white">
									{formatCurrency(item.purchase_price_rm)}
								</td>
								<td class="p-4 font-mono text-gray-900 dark:text-white">
									{formatCurrency(item.expected_return_rm)}
								</td>
								<td class="p-4 font-mono font-semibold text-green-600 dark:text-green-400">
									{formatCurrency(item.profit_earned_rm)}
								</td>
								<td class="p-4 text-gray-900 dark:text-white">
									{item.profit_rate_pa}%
								</td>
								<td class="p-4 text-gray-900 dark:text-white">
									{formatDate(item.start_date)}
								</td>
								<td class="p-4 text-gray-900 dark:text-white">
									{formatDate(item.maturity_date)}
								</td>
								<td class="p-4">
									<span
										class="px-2.5 py-0.5 rounded-md text-xs font-medium border"
										style={`background-color: ${item.status.color}20; color: ${item.status.color}; border-color: ${item.status.color}40;`}
									>
										{item.status.label}
									</span>
								</td>
							</tr>
						))}
					</tbody>
				</table>
			</div>
		</div>
	</div>
</div>

<script>
	import './Portfolio.client.ts';
</script>

<style is:global>
	/* chart styles */
	.apexcharts-tooltip {
		@apply bg-white dark:bg-gray-700 text-gray-500 dark:text-gray-400 border-0 rounded-lg shadow-lg !important;
	}

	.apexcharts-tooltip .apexcharts-tooltip-title {
		@apply py-2 px-4 bg-gray-100 dark:bg-gray-600 border-b border-gray-200 dark:border-gray-500 !important;
	}

	.apexcharts-xaxistooltip {
		@apply text-gray-500 border-0 bg-white dark:bg-gray-700 dark:text-gray-300 rounded-lg shadow-lg !important;
	}

	.apexcharts-tooltip .apexcharts-tooltip-text-y-value {
		@apply dark:text-white;
	}

	.apexcharts-xaxistooltip-text {
		@apply font-medium text-sm !important;
	}

	.apexcharts-xaxistooltip:before,
	.apexcharts-xaxistooltip:after {
		@apply border-0 !important;
	}

	/* Tab styles */
	.tab-button {
		@apply text-gray-500 dark:text-gray-400 border-gray-300 dark:border-gray-600;
	}

	.tab-button.active {
		@apply text-primary-600 dark:text-primary-500 border-primary-600 dark:border-primary-500;
	}

	.tab-button:hover:not(.active) {
		@apply text-gray-600 dark:text-gray-300 border-gray-300 dark:border-gray-500;
	}

	.tab-content {
		display: block;
	}

	.tab-content.hidden {
		display: none;
	}

	.tab-content.active {
		display: block;
	}
</style>
